FROM rocker/shiny:4.4.1

ARG DEBIAN_FRONTEND=noninteractive
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY
ENV http_proxy=${HTTP_PROXY} https_proxy=${HTTPS_PROXY} no_proxy=${NO_PROXY}
ENV HTTP_PROXY=${HTTP_PROXY} HTTPS_PROXY=${HTTPS_PROXY} NO_PROXY=${NO_PROXY}

RUN apt-get update && apt-get install -y \
    libcurl4-openssl-dev libssl-dev libxml2-dev \
    libfontconfig1-dev libfreetype6-dev libpng-dev libjpeg-dev libtiff5-dev \
    libharfbuzz-dev libfribidi-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/shiny-app/
COPY . /home/shiny-app/

# Install helpers
RUN R -q -e "install.packages(c('renv','BiocManager'), repos='https://cloud.r-project.org')"

# Make sure renv uses Bioconductor 3.21 and the right repos (single quotes to preserve $)
RUN R -q -e 'renv::consent(provided=TRUE)'
RUN R -q -e 'renv::settings$bioconductor.version("3.21"); options(repos = BiocManager::repositories()); print(options("repos"))'

# (Optional) pre-flight: show renv status before restore
RUN R -q -e 'renv::status()'

# Restore (in its own step for clearer error messages)
RUN R -q -e 'renv::restore()'

EXPOSE 3838
CMD ["R","-e","shiny::runApp(\"/home/shiny-app\", host=\"0.0.0.0\", port=3838)"]
